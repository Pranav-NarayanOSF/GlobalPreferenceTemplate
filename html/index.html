<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <script type="importmap">
          {
            "imports": {
              "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
            }
          }
        </script>

        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous"></link>
        <link rel="icon" href="data:;base64,iVBORw0KGgo="></link>
    </head>
    <body>
        <div id="app"> 
        </div>
    </body>
    
    <script type="module">
        import { createApp } from 'vue'

        const app = createApp({
          data() {
            return {
              message: "New Message",
              base_config : undefined,
              urlParams : undefined,
              base_data : undefined
            }
          },
          methods: {
            increment() {
              this.count++
            },
            getBaseData(){
              const headers = { "Content-Type": "application/json" };
              const body = {
                customer_id : this.base_config.customer_id,
                master_preference_de : this.base_config.master_preferences_de,
                preferences_de : this.base_config.preferences_target_de,
                locale: this.base_config.customer_locale,
                buId: this.base_config.subscriber_BU,
                master_customer_de : this.base_config.master_customer_de
              }
                fetch(this.base_config.pref_retrievalURL, {
                  method: 'POST', // or 'PUT'
                  headers: headers,
                  body: body,
                })
                  .then((response) => response.json())
                  .then((data) => {
                    console.log('Success:', data);
                  })
                  .catch((error) => {
                    console.log('Error:', error);
                  });
                
            },
            setURLParams(){
                return new Promise((resolve,reject)=>{
                    try{
                      const urlParams = new URLSearchParams(window.location.search);
                      resolve(urlParams);
                    }catch(ex){
                      reject(ex);
                    }
                })
            },
            setJSONConfig(urlParams){
              return new Promise(function(resolve,reject){
                  try{
                    let jsonObj = {
                      "customer_id" : urlParams.get('customer_id'),
                      "customer_locale" : urlParams.get('customer_locale'),
                      "subscriber_BU" : urlParams.get('customer_buId'),
                      "pref_retrievalURL":"https://mcpdwdml-zryw5dczwlf-f-f9kcm.pub.sfmc-content.com/sxvpd3duwja",
                      "pref_processing_URL":"https://mcpdwdml-zryw5dczwlf-f-f9kcm.pub.sfmc-content.com/nk4ctlggevc",
                      "captcha" : {
                        "key": "google_site_key"
                      },
                      "preferences_target_de" : {
                        "key":"3419051A-7B43-4B15-A810-F8A4615E9CD0",
                        "fieldMap":{
                            "bu_Id":"BU_ID",
                            "preference_ID":"Preference_ID",
                            "value":"Value"
                        }
                      },
                      "master_preferences_de": {
                        "key":"3419051A-7B43-4B15-A810-F8A4615E9CD0",
                        "fieldMap":{
                          "BU_ID" : "BU_ID",
                          "Preference_ID" : "Preference_ID",
                          "Preference_Type":"Preference_Type",
                          "Default_Values" : "Default_Values"
                        }
                      },
                      "master_customer_de" : {
                        "key":"ABCE2B54-FE0E-46FC-85BD-EC3F4C486D7D",
                        "fields":["Customer_ID","FirstName","LastName","EmailAddress"]
                      },
                      "logo_url":"https://osf.digital/library/media/osf/digital/common/header/osf_digital_logo.svg?h=60&la=en-AU&w=366&hash=C9F446367B2B20D20C0DDCB57814F986C5324002",
                      "header_color":"white",
                      "footer_color":"#389ab6",
                      "footer_links" : [{
                          label : "",
                          url : "",
                          icon_url : ""
                      }],
                      "external_end_point_target_de" : null,
                      "external_service":{
                          "authURL":"",
                          "restURL":"",
                          "endPoint" : "",
                          "clientId" : "",
                          "clientSecret":""
                      }
                    }
                    resolve(jsonObj); 
                  }catch(ex){
                    reject(ex);
                  }
              })
            }
          },
        
          // Lifecycle hooks are called at different stages
          // of a component's lifecycle.
          // This function will be called when the component is mounted.
          mounted() {
            this.setURLParams().then((urlParams)=>{
              this.urlParams = urlParams;
            }).catch((err)=>{
              console.log(err);
            }).finally(()=>{
              this.setJSONConfig(this.urlParams).then((jsonConfig)=>{
                this.base_config = jsonConfig;
              }).catch((err)=>{
                console.log(err);
              }).finally(()=>{
                this.getBaseData();
              });  
            })
            
          }
        })
        
        app.mount('#app')
    </script>
</html>